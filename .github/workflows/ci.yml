name: CI

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master", "develop" ]

# Global environment variables
env:
  COMPOSE_FILE: docker/test/docker-compose.yaml

jobs:
  # ============================================================================
  # Backend Tests (PHPUnit + Quality Checks)
  # ============================================================================
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # --- Setup ---
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- Caching ---
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('docker/test/php/**') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # --- Build Infrastructure ---
      - name: Build PHP image with cache
        run: |
          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --load -t test-php_test:latest \
            -f docker/test/php/Dockerfile \
            docker/test/php

          # Rotate cache to prevent bloat
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Start services
        run: docker compose -f ${{ env.COMPOSE_FILE }} up -d
        env:
          DOCKER_BUILDKIT: 1

      - name: Wait for services to be healthy
        run: |
          echo "‚è≥ Waiting for MariaDB..."
          timeout 90s bash -c 'until [ "$(docker inspect -f {{.State.Health.Status}} test_physiotherapy_mariadb)" == "healthy" ]; do sleep 3; done'
          echo "‚úÖ MariaDB ready"

          echo "‚è≥ Waiting for Redis..."
          timeout 30s bash -c 'until [ "$(docker inspect -f {{.State.Health.Status}} test_physiotherapy_redis)" == "healthy" ]; do sleep 2; done'
          echo "‚úÖ Redis ready"

          docker compose -f ${{ env.COMPOSE_FILE }} ps

      # --- Dependencies ---
      - name: Install Composer dependencies
        run: |
          # Fix permissions
          docker compose -f docker/test/docker-compose.yaml exec -T php_test chown -R www-data:www-data /var/www/html

          # Install with optimizations
          docker compose -f docker/test/docker-compose.yaml exec -T php_test \
            php -d memory_limit=512M /usr/bin/composer install \
            --no-interaction --prefer-dist --optimize-autoloader --no-scripts

          # Run post-install scripts
          docker compose -f docker/test/docker-compose.yaml exec -T php_test \
            composer run-script post-install-cmd --no-interaction || true

      # --- Setup ---
      - name: Generate JWT keys
        run: |
          docker compose -f docker/test/docker-compose.yaml exec -T php_test mkdir -p config/jwt
          docker compose -f docker/test/docker-compose.yaml exec -T php_test php bin/console lexik:jwt:generate-keypair --skip-if-exists

      - name: Setup database
        run: |
          echo "üóÑÔ∏è  Resetting database..."
          docker compose -f docker/test/docker-compose.yaml exec -T php_test php bin/console doctrine:schema:drop --force --full-database
          docker compose -f docker/test/docker-compose.yaml exec -T php_test php bin/console doctrine:schema:create
          docker compose -f docker/test/docker-compose.yaml exec -T php_test php bin/console doctrine:fixtures:load --no-interaction
          echo "‚úÖ Database ready"

      # --- Quality Checks ---
      - name: PHP CS Fixer
        continue-on-error: true
        run: |
          echo "üîç Running PHP CS Fixer..."
          docker compose -f docker/test/docker-compose.yaml exec -T php_test vendor/bin/php-cs-fixer fix --dry-run --diff || echo "‚ö†Ô∏è  Style issues found"

      - name: PHPStan (Level 8)
        continue-on-error: true
        run: |
          echo "üîç Running PHPStan..."
          docker compose -f docker/test/docker-compose.yaml exec -T php_test vendor/bin/phpstan analyse src --level=8 || echo "‚ö†Ô∏è  Type errors found"

      # --- Tests ---
      - name: PHPUnit Tests
        run: |
          echo "üß™ Running PHPUnit tests..."
          docker compose -f docker/test/docker-compose.yaml exec -T php_test php bin/phpunit

      # --- Cleanup ---
      - name: Stop containers
        if: always()
        run: docker compose -f ${{ env.COMPOSE_FILE }} down -v

  # ============================================================================
  # E2E Tests (Playwright)
  # ============================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: backend-tests

    steps:
      # --- Setup ---
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- Caching ---
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('docker/test/php/**') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      # --- Build Infrastructure ---
      - name: Build PHP image with cache
        run: |
          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --load -t test-php_test:latest \
            -f docker/test/php/Dockerfile \
            docker/test/php

      - name: Start services
        run: docker compose -f ${{ env.COMPOSE_FILE }} up -d
        env:
          DOCKER_BUILDKIT: 1

      - name: Wait for services to be healthy
        run: |
          timeout 90s bash -c 'until [ "$(docker inspect -f {{.State.Health.Status}} test_physiotherapy_mariadb)" == "healthy" ]; do sleep 3; done'
          timeout 30s bash -c 'until [ "$(docker inspect -f {{.State.Health.Status}} test_physiotherapy_redis)" == "healthy" ]; do sleep 2; done'

      # --- Dependencies ---
      - name: Install Composer dependencies
        run: |
          docker compose -f docker/test/docker-compose.yaml exec -T php_test chown -R www-data:www-data /var/www/html
          docker compose -f docker/test/docker-compose.yaml exec -T php_test \
            php -d memory_limit=512M /usr/bin/composer install \
            --no-interaction --prefer-dist --optimize-autoloader --no-scripts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install npm dependencies
        run: npm ci

      # --- Setup ---
      - name: Generate JWT keys
        run: |
          docker compose -f docker/test/docker-compose.yaml exec -T php_test mkdir -p config/jwt
          docker compose -f docker/test/docker-compose.yaml exec -T php_test php bin/console lexik:jwt:generate-keypair --skip-if-exists

      - name: Setup database with fixtures
        run: |
          echo "üóÑÔ∏è  Setting up database..."
          docker compose -f docker/test/docker-compose.yaml exec -T php_test php bin/console doctrine:schema:drop --force --full-database
          docker compose -f docker/test/docker-compose.yaml exec -T php_test php bin/console doctrine:schema:create
          docker compose -f docker/test/docker-compose.yaml exec -T php_test php bin/console doctrine:fixtures:load --no-interaction

      - name: Build frontend assets
        run: |
          echo "‚ö° Building with Vite..."
          npm run build

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      # --- Tests ---
      - name: Run Playwright E2E tests
        run: |
          echo "üé≠ Running E2E tests..."
          npx playwright test
        env:
          CI: true

      # --- Artifacts ---
      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: var/log/playwright/report/
          retention-days: 14

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots
          path: var/log/playwright/test-results/**/*.png
          retention-days: 7

      # --- Cleanup ---
      - name: Stop containers
        if: always()
        run: docker compose -f ${{ env.COMPOSE_FILE }} down -v
