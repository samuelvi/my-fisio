services:
  # MariaDB Database (Test)
  mariadb_test:
    image: mariadb:11
    container_name: test_physiotherapy_mariadb
    environment:
      MARIADB_DATABASE: physiotherapy_test_db
      MARIADB_USER: physiotherapy_user
      MARIADB_PASSWORD: physiotherapy_pass
      MARIADB_ROOT_PASSWORD: root_pass
    ports:
      - "3307:3306" # Different port than dev
    volumes:
      - ./mariadb/data:/var/lib/mysql
      # Custom MariaDB configuration (utf8mb4 defaults)
      - ../common/mariadb/my.cnf:/etc/mysql/conf.d/custom.cnf:ro
    networks:
      - physiotherapy_test_network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis (Test)
  redis_test:
    image: redis:7-alpine
    container_name: test_physiotherapy_redis
    ports:
      - "6380:6379" # Different port than dev
    volumes:
      - ./redis/data:/data
    networks:
      - physiotherapy_test_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # PHP-FPM (Test)
  php_test:
    image: test-php_test:latest
    build:
      context: ./php
      dockerfile: Dockerfile
    container_name: test_physiotherapy_php
    working_dir: /var/www/html
    volumes:
      - ../../:/var/www/html
    networks:
      - physiotherapy_test_network
    depends_on:
      mariadb_test:
        condition: service_healthy
      redis_test:
        condition: service_healthy
    environment:
      - DATABASE_URL=mysql://physiotherapy_user:physiotherapy_pass@mariadb_test:3306/physiotherapy_test_db?serverVersion=mariadb-11.0.0&charset=utf8mb4
      - REDIS_URL=redis://redis_test:6379
      - APP_ENV=test
      - APP_DEBUG=0
      - APP_SECRET=test_secret_12345
      - ITEMS_PER_PAGE=4

  # Nginx (Test)
  nginx_test:
    image: nginx:alpine
    container_name: test_physiotherapy_nginx
    ports:
      - "8081:80" # Different port than dev
    volumes:
      - ../../:/var/www/html
      - ../dev/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    networks:
      - physiotherapy_test_network
    depends_on:
      - php_test

  # Node.js for Vite (Test/Build)
  # We might not need this running constantly for E2E if we build assets first, 
  # but useful if we want to test HMR or serve assets.
  node_test:
    image: node:20-alpine
    container_name: test_physiotherapy_node
    profiles:
      - node
    working_dir: /var/www/html
    environment:
      - VITE_ITEMS_PER_PAGE=4
      - VITE_APP_ENV=test
    volumes:
      - ../../:/var/www/html
    networks:
      - physiotherapy_test_network
    command: sh -c "npm install && npm run build && tail -f /dev/null" # Build and stay alive

networks:
  physiotherapy_test_network:
    driver: bridge
